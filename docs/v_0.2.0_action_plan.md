Here’s the action plan for version 0.3.0 focusing on advanced REPL features: line editing/history, meta commands, and non-blocking execution.

Version 0.3.0 — Advanced REPL Plan

Phase 0: UX decisions and semantics (15–30 minutes)
- Line editing and history
    - Adopt a line editor with:
        - Left/Right: move cursor within the current editing buffer.
        - Up/Down: navigate submission history; pressing Up at an empty buffer loads the last submitted program (Bash-like).
        - Multiline editing: keep the current “submit on EOF” model. Enter inserts newlines; EOF (Ctrl-D on Unix/macOS, Ctrl-Z then Enter on Windows) submits the entire buffer for execution.
- Meta commands
    - Prefix: lines starting with ":" are meta commands and are handled immediately on Enter (not added to the program buffer).
    - Commands:
        - :exit — Immediately exit (same as Ctrl-C semantics: exit code 0).
        - :help — Show advanced help with key bindings, meta commands, EOF notes, and timeout policy.
        - :reset — Clear the current editing buffer (does not affect history).
        - :dump — Print the current editing buffer to stdout, with optional line numbers (e.g., :dump or :dump -n).
- Non-blocking interpreter
    - Guarantee: execution cannot block indefinitely.
    - Policy:
        - Step limit: abort if instruction count exceeds a configurable limit (default reasonable value, e.g., 10,000,000).
        - Wall-clock timeout: abort if execution exceeds a configurable duration (default e.g., 2 seconds).
        - Both limits configurable via CLI flags and/or environment variables.
        - On abort: print a concise timeout/limit message and re-prompt; REPL stays responsive.
- Acceptance: A compact section is added to docs describing the above behavior and defaults.

Phase 1: Line editor integration (60–120 minutes)
- Task: Integrate a mature Rust line-editing crate that supports:
    - Multiline editing, history, custom keybindings, and reading until EOF.
    - Basic navigation keys work out-of-the-box: Left/Right move; Up/Down cycle history.
- Behavior mapping:
    - Initialize in multiline mode.
    - Enter inserts newline; EOF submits buffer.
    - History entries represent full program submissions, not individual lines.
    - Up at an empty buffer loads the last history entry; Up/Down cycles through previous/next entries.
- Prompt: Continue using a concise prompt (e.g., "bf> ").
- Acceptance:
    - Manual: You can type text, move with Left/Right; Up reloads the last submission; EOF submits successfully.
    - History persists within the session; optional file-backed persistence can be deferred.

Phase 2: Meta command parsing and execution (45–75 minutes)
- Task: Recognize a line starting with ":" as a meta command when the cursor is on a new line.
- Commands:
    - :exit — Exit immediately with code 0 (consistent with Ctrl-C behavior).
    - :help — Print:
        - Keys: Left/Right, Up/Down, EOF combos per OS.
        - Meta commands: :exit, :help, :reset, :dump (with examples).
        - Timeout/step-limit defaults and how to configure.
    - :reset — Clear the current buffer (cursor to start of empty buffer).
    - :dump — Print current buffer to stdout; support an optional -n flag to show line numbers.
- Interaction rules:
    - Meta commands do not append to history.
    - :dump prints without modifying buffer; :reset clears without altering history.
- Acceptance:
    - Manual: Each command behaves as defined and does not corrupt the buffer or history.

Phase 3: Execution isolation and non-blocking guarantees (90–150 minutes)
- Task: Ensure program execution cannot hang the REPL.
- Design:
    - Run the interpreter on a dedicated worker thread.
    - Implement cooperative cancellation via:
        - Step counting inside the interpreter loop; return a specific error when exceeding the step limit.
        - Wall-clock timeout enforced by the REPL; if the worker doesn’t finish in time, signal cancellation and join with a deadline. If cooperative cancellation isn’t possible at a specific point, terminate the worker thread after reporting a timeout (documented limitation if necessary).
- Configuration:
    - Flags: --timeout <ms>, --max-steps <n> (with sensible defaults).
    - Env vars (fallback): BF_TIMEOUT_MS, BF_MAX_STEPS.
- Errors:
    - On step limit: “Execution aborted: step limit exceeded (N).”
    - On timeout: “Execution aborted: wall-clock timeout (T ms).”
- Acceptance:
    - Manual: Running an infinite loop gets aborted and returns to prompt quickly.
    - The REPL remains responsive before, during, and after aborts.

Phase 4: Signal handling interplay (30–45 minutes)
- Task: Keep existing Ctrl-C behavior: immediate, clean exit with code 0.
- Considerations:
    - Ensure signal handling is initialized before the REPL loop.
    - If Ctrl-C happens during execution, exit immediately; ensure worker thread doesn’t block shutdown.
- Acceptance:
    - Manual: Start a long-running/infinite program; press Ctrl-C; the process exits with code 0.

Phase 5: I/O and flushing polish (15–30 minutes)
- Task: Maintain explicit flushes after prompt, outputs, and errors to avoid interleaving.
- Acceptance:
    - Manual: Prompts and outputs appear promptly and in order.

Phase 6: Tests and reliability (90–180 minutes)
- Integration tests (assert_cmd + predicates):
    - Valid program submits via stdin; assert output and that process remains interactive (or gracefully terminates when stdin closes).
    - Invalid program (syntax/runtime): assert concise error and continued usability.
    - Empty submission (immediate EOF): re-prompt behavior consistent and non-crashing.
    - Timeout/step limit:
        - Provide a non-terminating program; assert process reports timeout/step-limit message and doesn’t hang on CI.
    - :help/:exit/:reset/:dump:
        - Send lines beginning with meta commands; assert expected stdout and exit code for :exit.
- Notes:
    - Automated terminal key simulation (Up/Left) is brittle; cover via manual QA checklist below rather than CI.
- Acceptance: Tests pass on CI for target platforms.

Phase 7: Documentation and help text (30–45 minutes)
- Task: Update README/help:
    - Key bindings: Left/Right movement; Up/Down history; EOF per OS.
    - Meta commands with examples:
        - :exit — quit immediately.
        - :help — show this information.
        - :reset — clear the current buffer.
        - :dump [-n] — print current buffer (optionally with line numbers).
    - Non-blocking policy: default timeout and step limit; how to configure flags/env.
- Acceptance: Docs are concise, consistent, and discoverable via :help.

Phase 8: Manual QA checklist (20–30 minutes)
- Script:
    - Type “+++.” then EOF; verify expected output and prompt returns.
    - Press Up; last program appears in the editor; edit it; EOF to run.
    - Use Left/Right to navigate and edit inside the line; insert/delete works as expected.
    - :dump shows buffer; :dump -n shows line numbers; :reset empties it; history remains intact.
    - Start a non-terminating loop; verify timeout/step-limit message and prompt returns.
    - Press Ctrl-C during an execution; process exits with code 0.

Clarifications on :reset and :dump
- :reset — Clears only the current in-memory editing buffer; does not impact submission history or any persisted state.
- :dump — Prints the current editing buffer to stdout for inspection. With -n, it prefixes line numbers. It does not parse or execute the buffer, nor does it alter the buffer or history.

Risks and mitigations
- Terminal/keybinding portability: rely on the line editor’s cross-platform support; keep custom bindings minimal.
- Timeouts vs. blocking I/O: prefer cooperative cancellation via step counting; use a worker thread with a timeout fallback so the REPL thread stays responsive.
- History persistence: session-only initially to reduce complexity; file-backed history can be added later behind a small feature gate.

Deliverables checklist (one-liner each)
- Multiline-capable line editor integrated; Left/Right and Up/Down behave as specified.
- Submission history of prior buffers; Up at empty loads last submission.
- Meta commands: :exit, :help, :reset, :dump (with -n).
- Execution isolation with step limit and wall-clock timeout; clear abort messages.
- Ctrl-C still exits immediately with code 0.
- Updated tests for meta commands and non-blocking behavior; documented manual checks for key navigation.
- Updated help/README with advanced usage.

If you want, I can sketch CLI flag names, default values, and the :help text copy so you can drop it straight into the help output.
